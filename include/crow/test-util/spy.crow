no-std
import
	../col/arr: arr
	../col/mut-arr: ~=, move-to-arr!, mut-arr, new
	../fun-util: subscript
	../misc: typed
	../tuple: new, pair

spy-act1<out, in> record mut
	.calls-builder in mut[]
	fn act out(in)

# Empties the list of calls and returns it.
calls<out, in> in[](a spy-act1<out, in>)
	a.calls-builder move-to-arr!

spy-act<out, in> spy-act1<out, in>(f act out(in))
	calls in mut[] = ()
	calls, in =>
		calls ~= in
		f[in]

spy-act<out, in> spy-act1<out, in>(value out)
	calls in mut[] = ()
	calls, in =>
		calls ~= in
		value

spy-act2<out, in0, in1> record mut
	.calls-builder pair<in0, in1> mut[]
	fn act out(in0, in1)

# Empties the list of calls and returns it.
calls<out, in0, in1> pair<in0, in1>[](a spy-act2<out, in0, in1>)
	a.calls-builder move-to-arr!

spy-act<out, in0, in1> spy-act2<out, in0, in1>(f act out(in0, in1))
	calls pair<in0, in1> mut[] = ()
	calls, (a, b) =>
		# TODO: 'typed' should be unnecessary
		calls ~= (a, b).typed@<pair<in0, in1>>
		f[a, b]
